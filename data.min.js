/*!
* Qstore
* v0.7.4
*
* smart tool for work with collections
* @license Licensed under the MIT license.
* @see http://github.com/holiber/qstore
*
* build at 2013-11-26 1:22
*/
!function(a){function b(a,b,d){if(a)for(var f in a)b[f]="function"==typeof a[f]&&"function"==typeof d[f]&&e.test(a[f])?c(a[f],d[f]):a[f]}function c(a,b){return function(){var c=this._super;this._super=b;try{return a.apply(this,arguments)}finally{this._super=c}}}var d=function(){};d.extend=function(a,c){function e(){this.init&&this.init.apply(this,arguments)}var f=[];"[object Array]"=={}.toString.apply(arguments[0])&&(f=arguments[0],a=arguments[1],c=arguments[2]),e.prototype=d.inherit(this.prototype),e.prototype.constructor=e,e.extend=d.extend,b(c,e,this);for(var g=0;g<f.length;g++)b(f[g],e.prototype,this.prototype);return b(a,e.prototype,this.prototype),e};var e=/xyz/.test(function(){})?/\b_super\b/:/./;d.inherit=Object.create||function(a){function b(){}return b.prototype=a,new b};var f=a.Qstore=d.extend({init:function(a){this.changes={},this.softMode=f.softMode,this.sortFields=null,this.reduce=$.extend({},a);var b=this.unpack(a);this.rows=b.rows,this.columns=b.columns,this.lastIdx=b.lastIdx,this.listener=function(){},this.computed={},this.defaults={}},size:function(){return this.rows&&this.rows.length||0},unpack:function(a){var b={columns:["idx"],rows:[],lastIdx:1};if(!a)return b;if($.isArray(a)){if(!a.length)return b;var c=a[0],d=["idx"],e=1,f=[];for(var g in c)d.push(g);for(var h=0;h<a.length;h++){var i=$.extend({idx:e},a[h]);f.push(i),e++}return{rows:f,columns:d,lastIdx:e}}if(!a.columns)return b;for(var d=["idx"].concat(a.columns),e=1,f=[],h=0;h<a.rows.length;h++){for(var i={idx:e},j=0;j<a.columns.length;j++)i[a.columns[j]]=a.rows[h][j];f.push(i),e++}return{rows:f,columns:d,lastIdx:e}},pack:function(a,b){var c=b||this.columns,d=a?this.find(a):this.rows,e=[];for(var f in d){for(var g=d[f],h=[],i=0;i<c.length;i++)h.push(g[c[i]]);e.push(h)}return{columns:c,rows:e}},find:function(a,b,c){return f.findIn(this.rows,a,b,c)},search:function(a,b,c){return new f(this.find(a,b,c))},findOne:function(a,b,c){return c=c||{},c=$.extend({},{limit:1},c),this.find(a,b,c)[0]},indexBy:function(a,b){return f.indexBy(this.rows,a,b)},mapOf:function(a,b){return f.mapOf(this.rows,a,b)},groupBy:function(){var a=Array.prototype.slice.call(arguments);return a.unshift(this.rows),new f(f.groupBy.apply(f,a))},each:function(a,b){b||(b=a);var c=this.find(a,{goNext:b});return c.length},getList:function(a,b){return f.getList(this.rows,a,b)},fire:function(a,b){this.listener(a,b,this)},sort:function(a,b){if(!a)return!1;if($.isFunction(a))return this.rows.sort(a),this.fire("sort",a),void 0;for(var c=$.isArray(a)?a:[a],d=this,e=0;e<c.length;e++){var f=c[e];if("string"==typeof f){f=f.split(":");var g=f[1]||"asc";c[e]={fieldName:f[0],order:g}}}this.sortFields=c||this.sortFields||[{fieldName:"idx",order:"asc"}];var h=function(a,c,e){e=e||0;var f=void 0!==d.sortFields[e].zeroIsLast?d.sortFields[e].zeroIsLast:b,g=d.sortFields[e].fieldName;if(f&&a[g]!==c[g]){if(!a[g])return 1;if(!c[g])return-1}if(a[g]==c[g]){var j=d.sortFields[e+1];if(!j)return a.idx-c.idx;var k=j.order||"asc";return"asc"==k?h(a,c,e+1):i(a,c,e+1)}return a[g]<c[g]?-1:a[g]>c[g]?1:"number"==typeof a[g]||"number"==typeof c[g]?"number"==typeof a[g]?1:-1:"string"==typeof a[g]||"string"==typeof c[g]?"string"==typeof a[g]?-1:1:a.idx-c.idx},i=function(a,c,e){e=e||0;var f=void 0!==d.sortFields[e].zeroIsLast?d.sortFields[e].zeroIsLast:b,g=d.sortFields[e].fieldName;if(f&&a[g]!==c[g]){if(!a[g])return-1;if(!c[g])return 1}if(a[g]==c[g]){var j=d.sortFields[e+1];if(!j)return c.idx-a.idx;var k=j.order||"asc";return"asc"==k?h(a,c,e+1):i(a,c,e+1)}return a[g]<c[g]?1:a[g]>c[g]?-1:"number"==typeof a[g]||"number"==typeof c[g]?"number"==typeof a[g]?-1:1:"string"==typeof a[g]||"string"==typeof c[g]?"string"==typeof a[g]?1:-1:c.idx-a.idx},j=this.sortFields[0];return j.order=j.order||"asc","desc"==j.order?this.rows.sort(i):this.rows.sort(h),this.fire("sort",a),this},update:function(a,b,c){var d=b?a:null,e=b?b:a,g="boolean"==typeof b?b:"boolean"==typeof c?c:!1;g=g||this.softMode;for(var h=0,i=[],j=0;j<this.rows.length;j++){var k=this.rows[j];if(!d||f.test(k,d)){var l=$.isFunction(e)?e(k):e;if(!l)continue;h++;var m=this.changes[k.idx]||{},n={action:"update",source:m.source||$.extend({},k),values:$.extend({},m.values||{},l),current:null};for(var o in l)k[o]=l[o];n.current=k,g||(i.push($.extend({},n,{patch:l})),this.changes[k.idx]=n)}}return this.compute(),i=new f(i),g||this.fire("change",{action:"update",changes:i}),h},patch:function(a,b,c){if(b=b||"idx",c=c||this.softMode,!a)return 0;for(var d={},e=0;e<a.length;e++)d[a[e][b]]=a[e];this.update(function(a){if(!d[a[b]])return!1;var c=$.extend({},d[a[b]]);return delete c[b],c},c)},add:function(a,b){a=$.isArray(a)?a:[a],b=b||this.softMode;for(var c=[],d=[],e=0;e<a.length;e++){var f=a[e];for(var g in this.defaults)void 0===f[g]&&(f[g]=this.defaults[g]);f.idx=++this.lastIdx;var h={action:"add",values:f};b||(this.changes[f.idx]=h),d.push(h),c.push(f)}return this.rows=c.concat(this.rows),this.compute(),this.sortFields=null,this.fire("change",d),!0},remove:function(a,b){b=b||this.softMode;var c=[],d=0;for(i=0;i<this.rows.length;i++){var e=this.rows[i];f.test(e,a)&&(d++,b?this.changes[e.idx]&&delete this.changes[e.idx]:this.changes[e.idx]?this.changes[e.idx].action="remove":this.changes[e.idx]={action:"remove",source:e},c.push(this.changes[e.idx]),this.rows.splice(i,1),i--)}return c=new f(c),b||this.fire("change",{action:"remove",changes:c}),d},rollback:function(){for(var a=this.rows.length;a--;){var b=this.rows[a],c=this.changes[b.idx];if(c)switch(c.action){case"update":this.rows[a]=c.source;break;case"add":this.rows.splice(a,1)}}for(var d in this.changes){var c=this.changes[d];"remove"==c.action&&this.rows.push(c.source)}this.fire("change",{action:"rollback",changes:$.extend({},this.changes)}),this.changes={}},commit:function(a){var b=this.changes.length;return a||this.fire("commit"),this.changes={},b},addFields:function(a){a instanceof Array||(a=[a]);var b=a.length,c=[];if(!b)return!1;for(var d=0;b>d;d++){var e=$.extend({name:!1,compute:!1},"string"==typeof a[d]?{name:a[d]}:a[d]);if(e.name){var f=!1,g=~$.inArray(e.name,this.columns);g||(f=!0,this.columns.push(e.name)),e.compute&&(this.computed[e.name]=e.compute),void 0!=e.default&&(this.defaults[e.name]=e.default,f&&c.push(e.name))}}if(c.length)for(var d=0;d<this.rows.length;d++)for(var h=this.rows[d],i=0;i<c.length;i++){var j=c[i];void 0===h[j]&&(h[j]=this.defaults[j])}return this.compute(),this.fire("change",{action:"addFields",fields:a}),!0},compute:function(){for(var a=this.size();a--;)for(var b=this.columns.length;b--;){var c=this.columns[b];this.computed[c]?this.rows[a][c]=this.computed[c](this.rows[a]):void 0===this.rows[a][c]&&(this.rows[a][c]="")}},getCopy:function(b){var c=this.rows;b&&(c=this.find(b));var d=new a.Qstore(JSON.parse(JSON.stringify({columns:this.columns,rows:[]})));return d.rows=JSON.parse(JSON.stringify(c)),d.lastIdx=this.lastIdx,d},removeFields:function(a){if(a){a instanceof Array||(a=[a]);for(var b=0;b<a.length;b++){var c=a[b],d=this.columns.indexOf(c);~d&&this.columns.splice(d,1),delete this.computed[c],delete this.defaults[c]}for(var b=0;b<this.rows.length;b++)for(var e=0;e<a.length;e++){var c=a[e];delete this.rows[b][c]}this.fire("change",{action:"removeFields",fields:a})}},getChanges:function(){if(this.changes.length)return null;var a=[];for(var b in this.changes){var c=this.changes[b];c.idx=b,a.push(c)}return new f(a)},getChangesMap:function(a){a=a||"idx";var b=this.getChanges(),c={};return c.add=b.find({action:"add"},["values:"]),c.remove=b.search({action:"remove"}).getList("source."+a),c.update=b.find(!0,["source."+a+":"+a,"values:"]),c},setListener:function(a){this.listener=a},setSoftMode:function(a){this.softMode=a}},{Class:d,operators:{},functions:{},softMode:!1,len:function(a){if(a.length)return a.length;var b=0;for(var c in a)b++;return b},first:function(a){if("string"==typeof a)return a.charAt(0);if(a instanceof Array)return a[0];if(a instanceof Object)for(var b in a)return a[b];return a},addOperator:function(a,b,c){void 0===c&&(c=!0),this.operators[a]={fn:b,isSimple:c}},removeOperator:function(a){delete this.operators[a]},addFunction:function(a,b){this.functions[a]=b},removeFunction:function(a){delete this.functions[a]},test:function(a,b,c,d){if(d||(d={item:a}),c&&"$and"!=c||"object"!=typeof b&&"function"!=typeof b){if("string"==typeof b&&"$"==b.charAt(0)&&"."==b.charAt(1)){var e=b.substr(2);b=f.getVal(d.item,e)}switch(c=c||"$eq"){case"$eq":return a==b;case"$ne":return a!=b;case"$gt":return a>b;case"$lt":return b>a;case"$gte":return a>=b;case"$lte":return b>=a;case"$like":return null!==a?~String(a).toLowerCase().indexOf(b):!1;default:var g=c.split("$")[1],h=f.operators[g].fn;if(!h)throw"operator "+g+" not found";return h(a,b,d)}}if(a instanceof Array){for(var i=0;i<a.length;i++)if(this.test(a[i],b,null,$.extend({},d,{currentItem:a})))return!0;return!1}if("$and"==c){for(var j=0;j<b.length;j++)if(!this.test(a,b[j],null,d))return!1;return!0}if(b instanceof RegExp)return b.test(String(a));if(b instanceof Array){for(var j=0;j<b.length;j++)if(this.test(a,b[j],null,d))return!0;return!1}if("object"==typeof b){for(var j in b)if("$and"!=j)if("string"!=typeof j||"$"!=j.charAt(0)){if("string"==typeof j&&"$"==j.charAt(0)&&"."!=j.charAt(1)){var g=f.operators[j.split("$")[1]];if(g&&g.isSimple===!1){if(!g.fn(d.currentItem,b[j],d))return!1;continue}}if("object"!=typeof a)return!1;if(!this.test(f.getVal(a,j),b[j],null,d))return!1}else{var g=f.operators[j.split("$")[1]];if(g&&g.isSimple===!1)return g.fn(d.currentItem,b[j],d);if(!this.test(a,b[j],j,d))return!1}else if(!this.test(a,b[j],j,d))return!1;return!0}return"function"==typeof b?b(a):!1},findIn:function(a,b,c,d){if(!a)throw"empty data";if(!b)return[];c=c||!0,d=d||{};var e=d.limit,g=d.goNext;"number"==typeof e&&(e=[1,e]);for(var h=[],i=0,j=0;j<a.length;j++){var k=a[j];if(e&&i>=e[1])break;if(b===!0||f.test(k,b)){if(i++,g&&g(k,i,b)===!1)break;e&&i<e[0]||(c===!0?h.push(k):h.push(f.getFields(k,c,{})))}}return h},getList:function(a,b,c){"string"==typeof b&&(c=b,b=null),c=c||"idx";var d=[];a=b?f.findIn(a,b):a;for(var e=0;e<a.length;e++){var g=f.getVal(a[e],c);~$.inArray(g,d)||d.push(g)}return d},indexBy:function(a,b,c){c=$.extend({},{alwaysWrap:!1,undefinedKey:!1},c);var d={};b instanceof Array||(b=[b]);for(var e=b[0],g=0;g<a.length;g++){var h=a[g],i="function"==typeof e?e(h):f.getVal(h,e);if(0!==i&&!i){if(!c.undefinedKey)continue;i=c.undefinedKey}c.alwaysWrap?(d[i]||(d[i]=[]),d[i].push(h)):d[i]?d[i]instanceof Array?d[i].push(h):d[i]=[d[i],h]:d[i]=h}var j=b.splice(1);if(j.length)for(var k in d){var l=d[k]instanceof Array?d[k]:[d[k]];d[k]=f.indexBy(l,j,c)}return d},groupBy:function(){for(var a=Array.prototype.slice.call(arguments),b=a[0],c=a.splice(1),d=c[0],e=[],g="string"==typeof d?[d]:d,h=f.getAdditionalFields(g),i=0;i<b.length;i++){var j=b[i],k=f.getFields(j,g),l=f.findIn(e,k,!0,{limit:1})[0];l?l._g.push(j):(k._g=[j],e.push(k))}var m=c.splice(1);if(m.length)for(var i=0;i<e.length;i++){var n=e[i],o=[n._g].concat(m);n._g=f.groupBy.apply(f,o)}for(var i=0;i<e.length;i++){var n=e[i],p=f.getFields(n,h);$.extend(n,p)}return e},mapOf:function(a,b,c){return f.indexBy(a,b,$.extend({},{alwaysWrap:!0},c))},flatten:function(){},parseArgs:function(a){for(var b=a.split(","),c=[],d=0;d<b.length;d++){var e=b[d].trim();'"'==e.charAt(0)&&'"'==e.charAt(e.length-1)||"'"==e.charAt(0)&&"'"==e.charAt(e.length-1)?c.push(e.substr(1,e.length-2)):/^[\d\.]+$/.test(e)?c.push(Number(e)):"["==e.charAt(0)&&"]"==e.charAt(e.length-1)||"{"==e.charAt(0)&&"}"==e.charAt(e.length-1)?c.push(JSON.parse(e)):c.push(e)}return c},getVal:function(a,b,c,d){if("function"==typeof b)return b(a);var e=b.split("."),f=a;if(c){var g=this.functions[c];if(!g)throw"function "+c+" not found";return f=void 0===d?g(f):g(f,d)}for(var h=0;h<e.length;h++){var i=e[h];if("$"!=i.charAt(0)){if("object"!=typeof f)return void 0;f=f[i]}else{var j=i.split("$")[1].split("("),c=j[0],d=j[1]?j[1].substr(0,j[1].length-1):null,g=this.functions[c];if(!g)throw"function "+c+" not found";f=d?g(f,d):g(f)}}return f},getFields:function(a,b,c){"object"!=typeof b&&(b=[b]);var d={},e=null;if(b instanceof Array)for(var g=b.length;g--;){e=a;var h=null;if("string"==typeof b[g]){var i=b[g].split(":"),j=i[0],k=i[1];h=f.getField(e,j,k)}else"object"==typeof b[g]?h=f.getFields(a,b[g],c):"function"==typeof b[g]&&(fnValue=b[g](a),"string"==typeof fnValue?(h={},h[fnValue]=!0):h=fnValue);$.extend(d,h)}else for(var l in b)if("$add"!=l){if(typeof b[l]===!0)var k=l,j=b[l];else var i=l.split(":"),j=i[0],k=i[1],m=b[l];$.extend(d,f.getField(a,j,k,void 0,m))}return d},getField:function(a,b,c,d,e){if(""===c)return f.getVal(a,b,d,e);void 0===c&&(c=b),b===!0&&(b=c);var g={};return g[c]=f.getVal(a,b,d,e),g},getAdditionalFields:function(a){var b=function(a){for(var b in a)if("$add"==b){var c=a[b];return c}return!1};if(a instanceof Array)for(var c=0;c<a.length;c++){var d=a[c];if("object"==typeof d){var e=b(d);if(e)return e}}return"object"==typeof a?b(a):void 0},setSoftMode:function(a){this.softMode=a}}),g={length:function(a){return f.len(a)},max:function(a){if(a instanceof Array){for(var b=-1/0,c=a.length;c--;)b=Math.max(b,a[c]);return b}},min:function(a){if(a instanceof Array){for(var b=1/0,c=a.length;c--;)b=Math.min(b,a[c]);return b}},abs:function(a){return Math.abs(a)},first:function(a){return f.first(a)},find:function(a,b){return b=f.parseArgs(b),b.unshift(a),f.findIn.apply(f,b)},mapOf:function(a,b){return f.mapOf(a,b)},indexBy:function(a,b){return f.indexBy(a,b)},test:function(a,b){return f.test(a,b)},getList:function(a,b){return b=f.parseArgs(b),b.unshift(a),f.getList.apply(f,b)},upper:function(a){return String(a).toUpperCase()},lower:function(a){return String(a).toLowerCase()},asNumber:function(a){return Number(a)},asString:function(a){return String(a)}},h={has:{isSimple:!1,fn:function(a,b){if("object"==typeof b)return f.findIn(a,b).length;if(a instanceof Array)if(b instanceof Array){for(var c=0;c<a.length;c++)if(~b.indexOf(a[c]))return!0}else if(~a.indexOf(b))return!0;return"object"==typeof a?void 0!==a[b]?!0:!1:"string"==typeof a?!!~a.indexOf(b):!1}}};for(var j in g)f.addFunction(j,g[j]);for(var j in h)f.addOperator(j,h[j].fn,h[j].isSimple)}(window);